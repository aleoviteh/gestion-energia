<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerencia - Sistema de Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        .sidebar-transition { transition: all 0.3s ease; }
        .hidden-module { display: none; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .bg-connection-ok { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .bg-connection-fail { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <!-- Login Overlay -->
    <div id="login-screen" class="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="flex flex-col items-center mb-8">
                <div class="bg-blue-600 p-4 rounded-full mb-4 shadow-lg shadow-blue-500/30">
                    <i data-lucide="shield-check" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 text-center uppercase tracking-tight">Gerencia de Energía</h1>
                <p class="text-slate-500 text-sm">Ingrese sus datos</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Usuario</label>
                    <input id="login-user" type="text" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input id="login-pass" type="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-alltext-sm" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-all shadow-lg active:scale-[0.98]">
                    Iniciar Sesión
                </button>
            </form>
        </div>
    </div>


    <!-- Main Layout (Hidden until Login) -->
    <div id="main-app" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-indigo-900 text-white w-64 flex-shrink-0 sidebar-transition">
            <div class="p-6 flex items-center justify-between">
                <span class="text-xl font-bold tracking-wider">GERENCIA</span>
                <button onclick="toggleSidebar()" class="lg:hidden"><i data-lucide="menu"></i></button>
            </div>
            
            <nav class="mt-6 px-4 space-y-2">
                <button onclick="showModule('inventario')" class="w-full flex items-center p-3 rounded-lg hover:bg-indigo-800 transition">
                    <i data-lucide="package" class="mr-3"></i> Inventario
                </button>
                <button onclick="showModule('plantas')" class="w-full flex items-center p-3 rounded-lg hover:bg-indigo-800 transition">
                    <i data-lucide="factory" class="mr-3"></i> Plantas
                </button>
                <button id="nav-usuarios" onclick="showModule('usuarios')" class="w-full hidden flex items-center p-3 rounded-lg hover:bg-indigo-800 transition">
                    <i data-lucide="users" class="mr-3"></i> Usuarios
                </button>
                <div class="pt-10">
                    <button onclick="handleLogout()" class="w-full flex items-center p-3 rounded-lg text-red-300 hover:bg-red-900/30 transition">
                        <i data-lucide="log-out" class="mr-3"></i> Cerrar Sesión
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b h-16 flex items-center justify-between px-8 shadow-sm">
                <div class="flex items-center space-x-4">
                    <h2 id="module-title" class="text-xl font-semibold text-gray-700 uppercase tracking-tight">Inventario</h2>
                    <span id="connection-status" class="status-dot bg-connection-fail" title="Estado de Firebase"></span>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <span id="user-display" class="font-medium bg-gray-100 px-3 py-1 rounded-full"></span>
                </div>
            </header>

            <!-- Modules Container -->
            <div id="content" class="flex-1 overflow-y-auto p-8">
                
                <!-- INVENTARIO MODULE -->
                <section id="mod-inventario" class="space-y-8">
                    <div class="flex space-x-4 mb-6 border-b pb-2">
                        <button onclick="showSubmodule('inv-list')" class="px-4 py-2 font-medium text-indigo-600 border-b-2 border-indigo-600">Visualizar</button>
                        <button id="btn-inv-add" onclick="showSubmodule('inv-add')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Ingresar</button>
                        <button id="btn-inv-ret" onclick="showSubmodule('inv-ret')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Retirar</button>
                        <button onclick="showSubmodule('inv-hist')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Historial</button>
                    </div>

                    <div id="inv-list" class="submodule">
                        <table class="w-full bg-white rounded-lg overflow-hidden shadow">
                            <thead class="bg-gray-100 text-left">
                                <tr>
                                    <th class="p-4">Código</th>
                                    <th class="p-4">Nombre</th>
                                    <th class="p-4">Marca</th>
                                    <th class="p-4">Tipo</th>
                                    <th class="p-4">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="inv-table-body"></tbody>
                        </table>
                    </div>

                    <div id="inv-add" class="submodule hidden space-y-4 max-w-lg bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold">Ingresar Artículo</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="inv-code" placeholder="Código" class="p-2 border rounded">
                            <input type="text" id="inv-name" placeholder="Nombre" class="p-2 border rounded">
                            <input type="text" id="inv-brand" placeholder="Marca" class="p-2 border rounded">
                            <input type="text" id="inv-type" placeholder="Tipo" class="p-2 border rounded">
                            <input type="number" id="inv-qty" placeholder="Cantidad" class="p-2 border rounded col-span-2">
                            <select id="inv-dept" class="p-2 border rounded col-span-2">
                                <option value="Cables">Cables</option>
                                <option value="Ferreteria">Ferreteria</option>
                                <option value="Energia">Energia</option>
                                <option value="Redes">Redes</option>
                                <option value="Plantas">Plantas</option>
                            </select>
                            <button onclick="saveItem()" class="col-span-2 bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">Guardar</button>
                        </div>
                    </div>

                    <div id="inv-ret" class="submodule hidden space-y-4 max-w-lg bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold">Retirar Artículo</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="ret-code" placeholder="Código" class="p-2 border rounded col-span-2">
                            <input type="number" id="ret-qty" placeholder="Cantidad a retirar" class="p-2 border rounded col-span-2">
                            <input type="text" id="ret-dest" placeholder="Destino" class="p-2 border rounded col-span-2">
                            <input type="text" id="ret-auth" placeholder="Quién autoriza" class="p-2 border rounded col-span-2">
                            <button onclick="withdrawItem()" class="col-span-2 bg-orange-600 text-white p-2 rounded hover:bg-orange-700">Procesar Retiro</button>
                        </div>
                    </div>

                    <div id="inv-hist" class="submodule hidden">
                        <table class="w-full bg-white rounded-lg overflow-hidden shadow">
                            <thead class="bg-gray-100 text-left text-xs uppercase text-gray-600">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Acción</th>
                                    <th class="p-4">Código</th>
                                    <th class="p-4">Cant.</th>
                                    <th class="p-4">Extra</th>
                                </tr>
                            </thead>
                            <tbody id="inv-hist-body"></tbody>
                        </table>
                    </div>
                </section>

                <!-- PLANTAS MODULE -->
                <section id="mod-plantas" class="hidden space-y-8">
                    <div class="flex space-x-4 mb-6 border-b pb-2">
                        <button onclick="showSubmodule('pl-list')" class="px-4 py-2 font-medium text-indigo-600 border-b-2 border-indigo-600">Visualizar</button>
                        <button id="btn-pl-add" onclick="showSubmodule('pl-add')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600 hidden">Nueva Planta</button>
                        <button id="btn-pl-reg" onclick="showSubmodule('pl-reg')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Registrar Uso</button>
                        <button onclick="showSubmodule('pl-hist')" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Historial</button>
                    </div>

                    <div id="pl-list" class="submodule space-y-4">
                        <div class="bg-white p-4 rounded shadow flex items-center space-x-4">
                            <label class="text-sm">Desde:</label>
                            <input type="date" id="filter-from" class="p-1 border rounded text-sm">
                            <label class="text-sm">Hasta:</label>
                            <input type="date" id="filter-to" class="p-1 border rounded text-sm">
                            <button onclick="renderPlantsList()" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm hover:bg-indigo-200">Filtrar</button>
                        </div>
                        <table class="w-full bg-white rounded-lg overflow-hidden shadow">
                            <thead class="bg-gray-100 text-left">
                                <tr>
                                    <th class="p-4">Nombre Planta</th>
                                    <th class="p-4">Gasoil Surtido (L)</th>
                                    <th class="p-4">Horas Encendido</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>

                    <div id="pl-add" class="submodule hidden space-y-4 max-w-lg bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold">Agregar Nueva Planta</h3>
                        <input type="text" id="pl-name-new" placeholder="Nombre de la planta" class="w-full p-2 border rounded">
                        <button onclick="createNewPlant()" class="w-full bg-indigo-600 text-white p-2 rounded">Crear</button>
                    </div>

                    <div id="pl-reg" class="submodule hidden space-y-4 max-w-lg bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold">Ingreso Manual de Datos</h3>
                        <select id="pl-select-reg" class="w-full p-2 border rounded"></select>
                        <input type="number" id="pl-gas" placeholder="Gasoil Surtido (L)" class="w-full p-2 border rounded">
                        <input type="number" id="pl-hrs" placeholder="Horas de Encendido" class="w-full p-2 border rounded">
                        <button onclick="savePlantLog()" class="w-full bg-indigo-600 text-white p-2 rounded">Registrar</button>
                    </div>

                    <div id="pl-hist" class="submodule hidden">
                        <table class="w-full bg-white rounded-lg overflow-hidden shadow">
                            <thead class="bg-gray-100 text-left">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Planta</th>
                                    <th class="p-4">Gasoil</th>
                                    <th class="p-4">Horas</th>
                                    <th class="p-4">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="pl-hist-body"></tbody>
                        </table>
                    </div>
                </section>

                <!-- USUARIOS MODULE -->
                <section id="mod-usuarios" class="hidden space-y-8">
                    <div class="max-w-xl bg-white p-6 rounded-lg shadow space-y-4">
                        <h3 class="text-xl font-bold border-b pb-2">Crear Nuevo Usuario</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="user-fullname" placeholder="Nombre Completo" class="p-2 border rounded col-span-2">
                            <input type="text" id="user-name" placeholder="Nombre de Usuario" class="p-2 border rounded">
                            <input type="password" id="user-pass" placeholder="Contraseña" class="p-2 border rounded">
                            <select id="user-level" class="p-2 border rounded col-span-2">
                                <option value="OBSERVADOR">OBSERVADOR</option>
                                <option value="MONITOREO">MONITOREO</option>
                                <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            </select>
                            <button onclick="createUser()" class="col-span-2 bg-green-600 text-white p-2 rounded hover:bg-green-700">Crear Usuario</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <h3 class="p-4 font-bold bg-gray-50 border-b">Usuarios Registrados</h3>
                        <table class="w-full text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4">Nombre</th>
                                    <th class="p-4">Usuario</th>
                                    <th class="p-4">Nivel</th>
                                    <th class="p-4">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIGURACIÓN Y ESTADO GLOBAL
        const firebaseConfig = {
    apiKey: "AIzaSyBkN6mE0YqWeAToslbgOAta80gjYi_C4Xk",
    authDomain: "gerencia-de-energia.firebaseapp.com",
    projectId: "gerencia-de-energia",
    storageBucket: "gerencia-de-energia.firebasestorage.app",
    messagingSenderId: "347966041919",
    appId: "1:347966041919:web:40cfe12b6dbba953712d8a",
    measurementId: "G-YMWMWKQYDL"
  };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = window.__app_id || 'gerencia-app';

        let currentUser = null;
        let localUsers = []; 
        let authenticatedUser = null;
        
        const getPublicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
        const getUsersPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'app_users');

        // EXPOSICIÓN GLOBAL DE FUNCIONES
        window.handleLogin = () => {
            const userIn = document.getElementById('login-user').value;
            const passIn = document.getElementById('login-pass').value;
            const found = localUsers.find(u => u.username === userIn && u.pass === passIn);

            if (found) {
                currentUser = found;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display').innerText = `${found.fullname} (${found.level})`;
                applyPermissions(found.level);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.handleLogout = () => location.reload();

        window.showModule = (modId) => {
            const sections = ['inventario', 'plantas', 'usuarios'];
            sections.forEach(s => document.getElementById(`mod-${s}`).classList.add('hidden'));
            document.getElementById(`mod-${modId}`).classList.remove('hidden');
            document.getElementById('module-title').innerText = modId;
        };

        window.showSubmodule = (subId) => {
            const parent = document.getElementById(subId).parentElement;
            parent.querySelectorAll('.submodule').forEach(s => s.classList.add('hidden'));
            document.getElementById(subId).classList.remove('hidden');
        };

        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('w-0');
            sb.classList.toggle('overflow-hidden');
        };

        window.createUser = async () => {
            if (!authenticatedUser) return;
            const fullname = document.getElementById('user-fullname').value;
            const username = document.getElementById('user-name').value;
            const pass = document.getElementById('user-pass').value;
            const level = document.getElementById('user-level').value;
            if (!fullname || !username || !pass) return;
            await addDoc(getUsersPath(), { fullname, username, pass, level });
            document.getElementById('user-fullname').value = "";
            document.getElementById('user-name').value = "";
            document.getElementById('user-pass').value = "";
        };

        window.deleteUser = async (id) => {
            if (!authenticatedUser) return;
            if (confirm('¿Eliminar este usuario?')) await deleteDoc(doc(getUsersPath(), id));
        };

        window.saveItem = async () => {
            if (!authenticatedUser) return;
            const data = {
                code: document.getElementById('inv-code').value,
                name: document.getElementById('inv-name').value,
                brand: document.getElementById('inv-brand').value,
                type: document.getElementById('inv-type').value,
                qty: parseInt(document.getElementById('inv-qty').value),
                dept: document.getElementById('inv-dept').value
            };
            if (!data.code || isNaN(data.qty)) return;
            await setDoc(doc(getPublicPath('inventario'), data.code), data);
            await addDoc(getPublicPath('inv_history'), {
                timestamp: Date.now(),
                action: 'INGRESO',
                code: data.code,
                qty: data.qty,
                extra: `Depto: ${data.dept}`
            });
            alert('Ingresado con éxito');
        };

        window.withdrawItem = async () => {
            if (!authenticatedUser) return;
            const code = document.getElementById('ret-code').value;
            const qty = parseInt(document.getElementById('ret-qty').value);
            const dest = document.getElementById('ret-dest').value;
            const authBy = document.getElementById('ret-auth').value;
            const docRef = doc(getPublicPath('inventario'), code);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const currentQty = snap.data().qty;
                if (currentQty >= qty) {
                    await updateDoc(docRef, { qty: currentQty - qty });
                    await addDoc(getPublicPath('inv_history'), {
                        timestamp: Date.now(),
                        action: 'RETIRO',
                        code: code,
                        qty: qty,
                        extra: `Destino: ${dest} | Autoriza: ${authBy}`
                    });
                    alert('Retiro exitoso');
                } else alert('Cantidad insuficiente');
            } else alert('Artículo no encontrado');
        };

        window.createNewPlant = async () => {
            if (!authenticatedUser) return;
            const name = document.getElementById('pl-name-new').value;
            if (!name) return;
            await setDoc(doc(getPublicPath('plantas'), name), { name });
            document.getElementById('pl-name-new').value = "";
            alert('Planta creada');
        };

        window.savePlantLog = async () => {
            if (!authenticatedUser) return;
            const name = document.getElementById('pl-select-reg').value;
            const gas = parseFloat(document.getElementById('pl-gas').value);
            const hrs = parseFloat(document.getElementById('pl-hrs').value);
            if (!name) return;
            await addDoc(getPublicPath('plantas_logs'), {
                plantName: name, gas: gas || 0, hrs: hrs || 0,
                timestamp: Date.now(), dateStr: new Date().toISOString().split('T')[0]
            });
            alert('Registro guardado');
        };

        window.deletePlantLog = async (id) => {
            if (!authenticatedUser) return;
            if (currentUser?.level === 'ADMINISTRADOR' && confirm('¿Eliminar este registro?')) {
                await deleteDoc(doc(getPublicPath('plantas_logs'), id));
            }
        };

        window.renderPlantsList = async () => {
            if (!authenticatedUser) return;
            const plantasSnap = await getDocs(getPublicPath('plantas'));
            const plantas = plantasSnap.docs.map(d => d.data());
            const logsSnap = await getDocs(getPublicPath('plantas_logs'));
            const allLogs = logsSnap.docs.map(d => d.data());
            
            const from = document.getElementById('filter-from').value;
            const to = document.getElementById('filter-to').value;
            const body = document.getElementById('pl-table-body');
            
            body.innerHTML = plantas.map(p => {
                const filteredLogs = allLogs.filter(l => {
                    const matchPlant = l.plantName === p.name;
                    const matchFrom = from ? l.dateStr >= from : true;
                    const matchTo = to ? l.dateStr <= to : true;
                    return matchPlant && matchFrom && matchTo;
                });
                const totalGas = filteredLogs.reduce((acc, curr) => acc + curr.gas, 0);
                const totalHrs = filteredLogs.reduce((acc, curr) => acc + curr.hrs, 0);
                return `<tr class="border-b"><td class="p-4 font-bold">${p.name}</td><td class="p-4 text-green-700 font-bold">${totalGas} L</td><td class="p-4 text-orange-700 font-bold">${totalHrs} Hrs</td></tr>`;
            }).join('');
        };

        // RENDER HELPERS
        function renderUsers() {
            const body = document.getElementById('users-table-body');
            body.innerHTML = localUsers.map(u => `
                <tr class="border-b">
                    <td class="p-4">${u.fullname}</td>
                    <td class="p-4 font-mono">${u.username}</td>
                    <td class="p-4 text-xs font-bold">${u.level}</td>
                    <td class="p-4 text-red-500 cursor-pointer" onclick="deleteUser('${u.id}')">${u.username !== 'Admin' ? 'Eliminar' : ''}</td>
                </tr>
            `).join('');
        }

        function renderInventory(items) {
            const body = document.getElementById('inv-table-body');
            body.innerHTML = items.map(i => `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-indigo-600">${i.code}</td><td class="p-4">${i.name}</td><td class="p-4">${i.brand}</td><td class="p-4">${i.type}</td><td class="p-4"><span class="bg-indigo-100 px-2 py-1 rounded text-indigo-800 font-bold">${i.qty}</span></td></tr>`).join('');
        }

        function renderInventoryHistory(hist) {
            const body = document.getElementById('inv-hist-body');
            hist.sort((a,b) => b.timestamp - a.timestamp);
            body.innerHTML = hist.map(h => `<tr class="border-b text-sm"><td class="p-4">${new Date(h.timestamp).toLocaleString()}</td><td class="p-4 font-bold ${h.action === 'INGRESO' ? 'text-green-600' : 'text-orange-600'}">${h.action}</td><td class="p-4">${h.code}</td><td class="p-4">${h.qty}</td><td class="p-4 text-xs italic">${h.extra}</td></tr>`).join('');
        }

        function renderPlantHistory(logs) {
            const body = document.getElementById('pl-hist-body');
            logs.sort((a,b) => b.timestamp - a.timestamp);
            body.innerHTML = logs.map(l => `<tr class="border-b text-sm"><td class="p-4">${l.dateStr}</td><td class="p-4 font-bold">${l.plantName}</td><td class="p-4">${l.gas} L</td><td class="p-4">${l.hrs} Hrs</td><td class="p-4">${currentUser?.level === 'ADMINISTRADOR' ? `<button onclick="deletePlantLog('${l.id}')" class="text-red-500">Eliminar</button>` : ''}</td></tr>`).join('');
        }

        function applyPermissions(level) {
            if (level === 'ADMINISTRADOR') {
                document.getElementById('nav-usuarios').classList.remove('hidden');
                document.getElementById('btn-pl-add').classList.remove('hidden');
            }
            if (level === 'OBSERVADOR') {
                document.getElementById('btn-inv-add').classList.add('hidden');
                document.getElementById('btn-inv-ret').classList.add('hidden');
                document.getElementById('btn-pl-reg').classList.add('hidden');
            }
        }

        // FUNCIÓN PARA INICIAR LISTENERS (SOLO TRAS AUTH)
        function startFirestoreListeners(user) {
            authenticatedUser = user;
            document.getElementById('connection-status').classList.replace('bg-connection-fail', 'bg-connection-ok');

            onSnapshot(getUsersPath(), (snapshot) => {
                localUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!localUsers.find(u => u.username === 'Admin')) {
                    setDoc(doc(getUsersPath(), 'admin_default'), {
                        fullname: 'Administrador Sistema', username: 'Admin', pass: 'admin1', level: 'ADMINISTRADOR'
                    });
                }
                renderUsers();
            }, (err) => {
                console.error("Users sync error", err);
                document.getElementById('connection-status').classList.replace('bg-connection-ok', 'bg-connection-fail');
            });

            onSnapshot(getPublicPath('inventario'), (snap) => renderInventory(snap.docs.map(d => d.data())), (err) => console.error("Inventory sync error", err));
            onSnapshot(getPublicPath('inv_history'), (snap) => renderInventoryHistory(snap.docs.map(d => d.data())), (err) => console.error("History sync error", err));
            onSnapshot(getPublicPath('plantas'), (snap) => {
                const plantas = snap.docs.map(d => d.data());
                window.renderPlantsList(); 
                document.getElementById('pl-select-reg').innerHTML = plantas.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            }, (err) => console.error("Plants sync error", err));
            onSnapshot(getPublicPath('plantas_logs'), (snap) => renderPlantHistory(snap.docs.map(d => ({id: d.id, ...d.data()}))), (err) => console.error("Logs sync error", err));
        }

        // INICIALIZACIÓN
        window.addEventListener('load', async () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Escuchamos el estado de autenticación
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    startFirestoreListeners(user);
                }
            });

            // Proceso de autenticación inicial (Obligatorio antes de consultas)
            try {
                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { 
                console.error("Firebase Auth failed", err); 
                document.getElementById('connection-status').classList.replace('bg-connection-ok', 'bg-connection-fail');
            }
        });

    </script>
</body>
</html>


